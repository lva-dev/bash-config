#!/usr/bin/env bash

function error() {
	echo -e "\e[31merror:\e[m failed to open vscode: $*" >&2
}

if [[ $(uname -r) =~ (m|M)icrosoft ]]; then
	windows_path_var="$(
		if ! cd /mnt/c/Windows; then
			exit 1
		fi

		cmd='/mnt/c/Windows/System32/cmd.exe'
		if ! ("$cmd" /c 'echo %PATH%'); then
			exit 2
		fi
	)"

	errc=$?

	if [[ $errc == 1 ]]; then
		error "failed to cd to '/mnt/c/Windows'" >&2
		exit 1
	elif [[ $errc == 2 ]]; then
		error 'failed to retrieve value of windows PATH variable' >&2
		exit 1
	fi

	vscode=
	found=n
	while IFS= read -r -d ';' dir; do
		vscode="$(wslpath -u "$dir")/code"
		if [[ -f "$vscode" ]]; then
			found=y
			break
		fi
	done <<<"$windows_path_var"

	if [[ $found == 'n' ]]; then
		error 'failed to locate vscode path' >&2
		exit 1
	fi

	"$vscode" "$@" &
else
	code "$@"
fi
